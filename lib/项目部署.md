# 项目部署

注：本文或许仅适用于开发、版署、内测等阶段的项目部署。项目正式运营时，可能会采用容器映像等方式进行更为快速且安全的部署工作。

## [目录](#目录)

* [创建实例](#创建实例)
* [环境搭建](#环境搭建)
  * [OTP](#otp)
  * [elixir](#elixir)
* [拉取代码](#拉取代码)
* [运行](#运行)

## [创建实例](#目录)

目前，**风暴魔域2.0**项目的相关服务器是配置在**238服务器**上的，而238是一台基于**CentOS-7.4**的Linux主机。

关于查看主机的系统和版本号：

```bash
cat /etc/redhat-release

CentOS Linux release 7.4.1708 (Core)
```

在各大云服务器提供商里，购买或创建一台CentOS-7的主机即可。为了完成后续的部署工作，我这里创建了一台内存2G的谷歌云台湾实例。

连接上服务器，先惯例升级吧，毕竟部署项目后，机器是不敢随意升级的。

```bash
yum update -y
```

## [环境搭建](#目录)

接下来搭建项目运行时所必备的环境。我们需要在机器上安装OTP和elixir。

### [OTP](#环境搭建)

在238服务器上使用的是**OTP-20**的版本

```bash
erl

1> erlang:system_info(otp_release).
"20"
```

首先需要安装必要依赖

```bash
yum install -y gcc gcc-c++ glibc-devel make ncurses-devel openssl-devel autoconf java-1.8.0-openjdk-devel git wget
```

依赖安装完毕后，需要下载源代码，然后进行编译安装

```bash
# 下载
wget http://erlang.org/download/otp_src_20.0.tar.gz

# 解压
tar -zxvf otp_src_20.0.tar.gz

# 安装
cd otp_src_20.0
./otp_build autoconf
./configure && make && make install
```

安装大概会花费几分钟的时间，成功后可参照之前的方式检查OTP版本,也可删除安装包文件。

### [elixir](#环境搭建)

238服务器的elixir版本是1.7.2，输入iex即可看到

```bash
# 拉取源码
git clone https://github.com/elixir-lang/elixir.git

# 更换版本
git branch -a
git checkout origin/v1.7
cd elixir
cat VERSION

# 编译安装
make clean test
make install

iex
```

**make clean test**的过程中，可能会出现报错，官方给出的解决方式是，重新更换分支后，再次进行如上的操作。如果仍然无法解决问题，也不用管他，只要不影响项目的运行即可。

## [拉取代码](#目录)

接下来，需要拉取服务器的代码

注：由于我这台测试机器是位于台湾谷歌云上的，难以访问公司内网，所以我用demo考核代码进行测试，但下方给出的命令，仍模拟公司内网的情景。

```bash
git clone http://192.168.1.170:8081/my2/server.git
```

为方便以后不用多次输入账号密码，可通过如下方法解决问题

```bash
git remote -v
> origin	http://192.168.1.170:8081/my2/server.git (fetch)
> origin	http://192.168.1.170:8081/my2/server.git (push)

git remote set-url origin http://账号:密码@192.168.1.170:8081/my2/server.git
```

也可以在.git目录里的config文件中修改

## [运行](#目录)

最后一步就是项目代码的运行了

```bash
cd server

mix clean
mix deps.get

iex -pa third_beams -S mix
```

至此，最基本的项目部署也就完成了。但目前公司还使用了**docker**容器管理项目，这部分的内容，将在后续进行补充

---
