# 服务器 sdk 相关对接总结

---
## Login服
---

#####   1. 对接内容
* login 服对接内容比较简单，主要是`账号验证`，

#####   2. 落实代码上
* 需要在 `api.ex` 中的 `resource :auth do` 代码块下添加新增的平台，并且为新增的平台添加单独的处理逻辑。
* 以西山居为例，添加平台 `:ks`，添加了代码 `:ks -> KSSDK.verify_login(platform, account_id, params[:accessToken], params[:version])`

#####   3. 容易踩坑点
* 注意配置的账号验证地址，需要放到`config.exs` 或 `prod.exs` 文件中，如西山居 `config :login_server, kssdk_host: "https://safeapi.kingsoftgame.com/uout/cp/token/check"`
* 开发期间是配置在 `dev.exs` 文件中，是没有问题的，但是最终打包的 `env` 是 `prod`，这条配置不会打入包内，导致账号验证不了。

---

---
## Idip服
---
#####   1. 对接内容
* 具体的对接内容是 sdk文档的接入，主要是平台支付的回调和一些预留的接口（如：查询用户信息）。

#####   2. 落实代码上
* `HttpService` 模块中新增一条 http service，如西山居：`{Plug.Adapters.Cowboy2, scheme: :http, plug: XsjRouter, options: [port: xsj_port]}`
* 具体处理逻辑参照代码。

![HttpService](/res/TIM截图20191011104428.png)

#####   3. 容易踩坑点
* 对接文档要求有生成sign的规则，需要注意确定中文在生成sign中的规则，避免生成的sign不一致。
* 务必测试中文问题。
* 有的返回码需要细化，方便定位问题出在平台回调还是idip服与realm服之间的调用。
* 统一的错误码可以统一处理

---

---
## Realm服
---
#####   1. 对接内容
* 具体的对接内容是 商品发放和用户账号信息查询。

#####   2. 落实代码上
* 西山居这边发放商品上沿用之前的规则，但是和之前的商品id有所区别，之前腾讯版多个商品使用同一条商品id，现在不同的商品id对应不同的商品，所以新增了产品ID表做中间转换。
* 需要注意，这种中间转换的表可能导致客户端和服务器处理的商品id不同，务必确保商品id多个表里配置一致（踩了不少坑。。。）

#####   3. 容易踩坑点
* 产品id配置需一致。
* 平台币购买魔石返还规则最后才新增需求，返还规则需求应该在对接前确认。

---
---
---

# loa 服务器 dclogger 的接入

---
## Realm服
---
#####   1. 对接内容
* 具体的对接内容是 日志上报（玩家升级，玩家登录，玩家充值）。
* 日志主要以文件的形式记录，再由平台给的脚本同步。

#####   2. 落实代码上
* 拆分base_msg（必需字段） 和其他字段。
* 单独启动进程来上报，避免在玩家进程上操作。
* 文件名的生成规则和目录地址需要在接入时确认，如dclogger日志的文件名生成为15分钟一个。
* 支付平台为"110"上报特殊处理

#####   3. 容易踩坑点
* 充值日志上报的时间点需要确定（收到回调上报还是发放时上报），以及上报时间不同导致的某些字段取不到如何处理。
* 充值金额需要确定单位。
* 日志上报需求可能和接入文档有出入，及时沟通，确认需求。

---
---
---

# loa 服务器发现的问题及优化总结---汇总

---
## Realm服
---
#####   1. 每日礼包使用金额做 key 导致玩家回档问题 --- 总结
* 内网没有出现的原因：使用的数据库版本不同。
* 但是正式服使用的版本为mongo 3.4.1，导致了正式服不支持浮点数做key，`没有任何报错和输出，这个问题比较隐晦`，目前做了兼容，`后续服务器环境搭建需要确认相关环境版本`。
* `即使正式服支持浮点数做key，依旧会有问题`，因为玩家数据出库会parse key，会导致`浮点数`的 `key` 转为 `int`，也会导致问题，比如两档，金额分别为 0.99 和 0.10 转换之后都是 0。
* 兼容：由于客户端需要使用金额读配置，所以此处的浮点做key不能省略，具体兼容是把浮点数放大取整，并且用一个tag标志是浮点key，取出再转换（存入和取出都需要小心，避免转换出错，使用try do并增加适当日志）。

> `注意：避免使用浮点数当key。`

![存入兼容](/res/TIM截图20191011105128.png)
![存入兼容](/res/TIM截图20191011104945.png)
![取出兼容](/res/TIM截图20191011105028.png)
![取出兼容](/res/TIM截图20191011104958.png)


#####   2. 七日盛典可以反复领取 --- 总结
* 每天重置会导致在线玩家的运营活动多套一层 `活动id` 的 key，导致玩家上线活动数据匹配不上被重置。
* 重置之后玩家可以重新领取已经领取过的任务，玩家可以多领很多道具。

> `后续注意`：运营活动，`跨天一定要反复自测`，活动`开启和关闭`也需要`多测试`。

![错误代码](/res/TIM截图20191011105520.png)

#####   3. 七日盛典清空了玩家其他运营活动数据（操作数据务必小心） --- 总结
* 操作玩家身上的数据一定小心，如果只需要操作某类活动数据，可以赋值中间变量去操作，最后再 merge 进去，避免直接操作玩家所有的运营活动数据。
* 一定确保不要多操作其他数据，自测期间多复测、检查，一些重要的操作加上操作日志，最好涉及操作前后的玩家数据。

> `注意：重要数据操作前后增加日志输出。`

![错误代码](/res/TIM截图20191011105825.png)

#####   4. 腾讯版 - 进入神劫降临活动选择回血导致玩家丢失幻兽的问题（操作数据务必小心） --- 总结
* 1、避免直接操作avatar模块的state，尽量使用现有处理逻辑，如果确实需要处理，重要的数据有必要增加日志输出。
* 2、幻兽相关的东西大部分在avatar这边，处理需要小心。
* 3、不管是策划还是数值新增的需求或者一些特殊的处理都需要写到策划案里面，比如这次的幻兽和玩家不能回血这个特殊处理和配置，测试那边不知道有这个特殊处理规则，策划案上也没有细化这些特殊处理。
* 4、处理一些细化的问题需要让测试知道，最好rtx上建个群讨论，到时候出问题了也方便核实，新改的案子记得通知策划上传。
* 5、自己负责的功能最好多复测几次，比如这次的幻兽问题，幻兽死亡，界面选择回血，才会出现丢失，合并之后自己可以多测几次，多种情况册数尽可能覆盖完全。
* 6、一定确保不要多操作其他数据，自测期间多复测、检查，一些重要的操作加上操作日志，最好涉及操作前后的玩家数据。

> `注意：重要数据操作前后增加日志输出，细化的操作一定确保测试知晓。`

![错误代码](/res/TIM截图20191011110145.png)

#####   5. 腾讯版 - 梦幻棋盘缺少配置问题导致活动异常 --- 总结
* 策划新增的活动需要内网复测，避免缺少配置导致的玩家数据异常。
* 配置问题导致的活动重要数据的异常可以不用做兼容，兼容可能会导致其他问题。
* 比如这次的梦幻棋盘格子表和就奖池都缺少配置，但是活动表配了新活动。
* 首先，导致客户端缺少配置，界面异常，其次，服务器上初始化的玩家奖池异常，即使加入了配置更新，依旧会导致最终奖池发放异常。
* 总结：错误初始化的活动避免复用

> `注意：错误初始化的活动避免复用，新活动务必复测，避免直接更新外网。`

#####   6. 邮件界面打不开（服务器做兼容，后续考虑优化客户端代码） --- 总结
* 邮件界面打不开的问题1、客户端区分了`装备id`和`道具id`，服务器这边没有做区分，`:i` 的离散配置使用装备id去读取就会导致报错。
* 但是邮件这里只涉及名字问题，客户端这块可以考虑后续优化。
* 具体兼容：增加`:e` 的离散配置，错误的邮件发给客户端时特殊处理。
* 邮件界面打不开的问题2、Gm后台发放的测试邮件内容和标题存在`空字符串`的情况，`空字符串`邮件标题和内容在客户端判定数字的代码返回值为true，会导致读取离散配置报错。
* 由于客户端不能动代码处理，服务器兼容处理空字符串为`" "`，确保客户端判定和显示没有问题。

> `注意：Gm发放邮件务必小心。`

![兼容代码](/res/TIM截图20191011110705.png)

#####   7. 腾讯版 - 巅峰召唤没有发放排行奖励错误 --- 总结
* 函数使用错误，逻辑混乱，导致排名奖励计算错误，少发放。

> `注意：某些库函数使用须确保逻辑正确，使用后需要自测。`

![错误代码](/res/TIM截图20191011111757.png)

#####   8. Redix 使用集群逻辑修改 --- 总结
* 修改代码确保redis配置支持 `单redis` 和 `多redix`，但是原有单redix配置方式不再支持。
* 单redis配置：  ![单redis配置](/res/TIM截图20191011112844.png)
* 多redis配置：  ![多redis配置](/res/TIM截图20191011113036.png)

> `注意：使用新库包可以多查下文档和使用，文档不详细可以参考下示例和源码。`

![代码修改](/res/TIM截图20191011113526.png)

#####   9. Tlog 流水原因复查和优化 --- 总结
* tlog 流水原因核对比较费时费力，后续涉及道具发放务必使用 `resolve`，并且加入 `action` 和 `sub_action`（需要记录二级流水原因时）
* 如：`{:resolve, %{action: {:seven_day_festival, :claim}, sub_action: sub_action, events: event, changed: changed}, Effect.from_rewards(reward)}`
* 在 `tlog.ex` 代码中 `source_of_action` 函数下补全 `action` 对应的流水原因，顺延就行。
* 不要格式化代码，代码格式参看函数开始的说明。
* 服务器中执行 `Tlog.Specs.generate_xml()` 生成xml文档，文档名 `logee.xml`，记得同步。

> `注意：后续涉及道具和货币发放务必增加 action 和 流水原因 。`

![流水原因格式1](/res/TIM截图20191011114623.png)
![流水原因格式2](/res/TIM截图20191011114700.png)

---