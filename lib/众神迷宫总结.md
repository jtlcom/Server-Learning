#### 众神迷宫问题总结

## 迷宫流程
![众神迷宫流程图](/res/众神迷宫流程图.jpg)

## 传送点的数据格式及传送点触碰
* 问题：在最初采用的是传说门的id对应传送类型的数据格式，这样做服务器就不能判断玩家究竟走的哪个传送门
* 解决方法：1.在活动启动的时候可以为每个传送门分配一个sn，数据格式%{layer => %{sn => %{type: type, pos: pos}}}。在每次进入场景时同步每层的传送门数据并创建传送门。使用之前的传送门触碰类型，通过对应的sn查找传送类型，最后将玩家拉入对应的场景。
           2.可以通过同步每层的传送门类型，在进入副本后去生成传送门，同时将sn存下来，按照上面的数据格式存入到场景进程字典中。其后的操作同上。

## 活动数据与场景数据同步问题
* 问题：在场景中操作活动数据，在同步到活动数据中就可能导致在上一个玩家修改了数据后还没有同步下一个玩家就获取到了数据，就可能导致数据出现错误。
* 解决方法：在场景中操作场景的数据，在活动方法中操作活动的数据，这样保证了每次操作完活动数据后都能立刻去更新活动数据，使下一个玩家在获取数据时都是最新数据。

## 场景分线问题
* 问题：如何对每层场景做分线处理
* 解决方法：玩家每进入一层地图都要做分线处理，并且从一线开始遍历，找到人数未满的分线将玩家拉入其中。如果人数都已满或者当前场景不存在分线，则重新分一条线。

```elixir
# 数据存储格式
%{scene_id1 => %{1 => {ids: [id1, id2], guid: guid}, 2 => %{...}}, scene_id2 => %{..} ...}
# 从分线中删除玩家信息
new_info = Policy.del_player_from_line(aid, scene_id, policy_data)
# 将玩家拉入新的分线中
{instance_id, index, info} =
      Policy.check_line_can_enter?(aid, current_scene_id, new_policy_data)
```

## Boss技能
* 问题：boss在死亡之前会循环变化属性和释放法术场
* 解决方法：由服务器创建boss,之后每次变换之前先判断boss是否死亡，如果没有死亡，则操作下一步，直到boss死亡。
  使用的方法是Process.send_after(self(), {...}, time)
