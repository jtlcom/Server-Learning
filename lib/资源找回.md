# 资源找回

## 涉及的玩家数据

```elixir
activity_data:%{
    act_id => %{
        entered: entered, 
        times: times, 
        bought: bought,
        missed: %{base: base, extra: extra, use_extra: use_extra}
    }
}

soul_exchange:%{exp: 2, last_time: 1574218558, missed: %{base: 1, extra: 1}}
```
>`act_id`：活动id；`entered`：活动已进入/参与次数；`tiems`：活动进入次数（来源于活动界面表）；`bought`：活动今天已购买次数；`missed`：能参与资源找回的活动才有此字段。

>`missed`： `base`：活动基础找回次数；`extra`：活动额外找回次数；`use_extra`：昨天使用了的找回次数

>`exp`：灵魂换购次数（来源于vip配置表）；`last_time`：上次更新时间；`missed`：同上。

---

## 资源找回

### 需求：

根据昨天未使用的活动次数，今天使用魔石/金币获取活动的相应奖励。

vip优化：根据昨天未使用的vip购买次数，今天可再次购买并找回资源。

### 注意：

今天的资源找回基本次数与额外次数都来源于昨天相应的未使用次数；昨天购买了但未使用的次数累计到今天的基本次数上；

`今天的基本找回次数 = 活动进入次数（活动界面表） + 昨天的购买次数 - 昨天进入次数`

`今天的vip额外找回次数 = vip购买次数（vip配置表） - 昨天的购买次数`

`昨天使用的额外次数 = 昨天的购买次数`

`基本次数找回花费 = 资源找回表 配置`

`额外次数找回花费 = 基本次数找回花费 + 额外次数购买花费（活动界面表）`

`灵魂换购的花费以及奖励都来源于角色经验表`

灵魂换购的逻辑与其它找回不同；其不属于活动类型，找回花费与奖励的来源也与其他找回不同。将其逻辑代码独立为一个函数单独处理。

---


