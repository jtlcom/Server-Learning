#陨落神域

判断玩家符合进入条件之后开启一个副本的进程 `Realm.start_instance/3`
单人进入只判断一个人的条件然后直接开启副本进程，多人进入判断每个人的条件之后发送消息给客户端，客户端再发送团队进入的消息给服务器，服务器再处理每个人进入。
进入之后客户端发送`:enter_success`消息，在SceneApi里初始化玩家带入场景的数据`MapEntityDef`并存进场景字典里面，最后会调到对应模块的player_enter

副本进程开启后，初始化场景`SceneApi.init_scene` 初始化场景ai `SceneAi.init/1`
初始化场景之后，在副本进程结束之前，进程使用计时器一直调用：
`SceneLoop.loop/3` 调用 `SpellLoop.loop/2` 调到abstract_scene的 `entity_die/3`, `entity_hurt/4` 再调到对应模块的entity_die，entity_hurt
`AbstractScene.on_timer/2` 用来检测副本是否结束，副本结算时间结束或者ai调用之后，通过`do_action/3`调到副本模块的 `on_instance_end` 进行副本结算处理，
最后执行`AbstractScene.instance_close/1`关闭副本进程，玩家退出副本

玩家退出副本清除buff的问题：
当回调函数返回`{:stop, reason, state}`，都会跑到`terminate/2`，进程退出，
副本进程退出之后不能通过执行`SceneApi.leave/3`来改变`last_pos`，而在avatar里面已经修改了`pos`
所以接受`:enter_success`消息之后，因为last_pos没有改变，所以执行`SceneApi.scene_change_recover/1`不能正常清除buff
解决办法，在副本进程关闭之前，手动添加退出副本命令`exit_instance`和`SceneApi.leave/3`

副本ai：
场景初始化将该地图的ai存在场景ai字典里面，通过调用触发接口调到`SceneAi.trigger_ai/2`





